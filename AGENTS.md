# Pluto - 项目路线图与规划

**项目**: Pluto  
**类型**: 单用户个人摄影作品展示  
**技术栈**: Next.js 15 + React 19 + TypeScript + Drizzle ORM + Cloudflare Workers  
**状态**: 生产就绪，持续开发中  
**最后更新**: 2026-02-08

---

## 目录

- [项目概述](#项目概述)
- [已完成功能](#已完成功能)
- [当前迭代](#当前迭代)
- [长期愿景](#长期愿景)
- [技术债务与改进](#技术债务与改进)
- [基础设施与运维](#基础设施与运维)
- [代码规范](#代码规范)

---

## 项目概述

Pluto 是一个**单用户**的个人摄影作品展示站点，基于 Next.js 15 构建并部署在 Cloudflare Workers 上。目标是为摄影师提供简洁、美观、响应式的作品展示体验，聚焦相册、分类、点赞、评论与密码保护内容等功能。

**核心价值主张：**

- 🎨 尊重原始宽高比的精美瀑布流布局  
- ⚡ Cloudflare Workers 边缘优化性能  
- 📱 移动优先的响应式设计  
- 🔒 密码保护相册（含 OTP）  
- 💬 相册评论系统  
- 🏷️ 分类与标签管理  
- 📊 EXIF 数据展示与管理  
- 🌐 RSS 订阅支持  

---

## 已完成功能

### ✅ 核心图库 (v1.0)

- [x] 基于 JavaScript 的瀑布流布局，保留宽高比
- [x] 响应式网格系统（根据视口自适应 1/2/3/4 列）
- [x] 无限滚动与分页
- [x] 带微光占位符的懒加载图片
- [x] 基于标签的分类筛选
- [x] 方向筛选（横向、纵向、方形）
- [x] 按日期（最新）、热度（点赞数）或浏览量排序

### ✅ 灯箱与图片查看器 (v1.0)

- [x] 全屏沉浸式查看体验
- [x] 键盘导航（Escape 键关闭，方向键切换）
- [x] EXIF 数据显示（相机、镜头、设置、位置）
- [x] 文件元数据（大小、上传日期）
- [x] 灯箱内点赞功能
- [x] 灯箱内浏览量展示
- [x] 流畅的过渡动画

### ✅ 相册系统 (v1.1)

- [x] 相册创建和管理
- [x] 带分页的相册列表
- [x] 带媒体网格的相册详情视图
- [x] 相册封面图片选择
- [x] 基于 OTP 令牌的密码保护
- [x] 相册点赞和浏览量追踪
- [x] 相册专属 RSS 订阅

### ✅ 互动功能 (v1.2)

- [x] 媒体项目的点赞/取消点赞
- [x] 相册的点赞/取消点赞
- [x] 点赞数显示
- [x] 相册浏览量追踪
- [x] 媒体浏览量追踪（KV 去重 + Bot 过滤）
- [x] 持久化状态管理

### ✅ 评论系统 (v1.3)

- [x] 带嵌套/层级结构的相册评论
- [x] 作者信息（姓名、邮箱、URL）
- [x] 评论提交表单
- [x] 带线程的评论列表

### ✅ 内容与静态页面 (v1.4)

- [x] 基于 Markdown 的内容系统
- [x] 关于页面
- [x] 隐私政策页面
- [x] 服务条款页面
- [x] 新闻订阅表单
- [x] 响应式头部/底部导航

### ✅ 数据库与基础设施 (v1.5)

- [x] Drizzle ORM 集成
- [x] Cloudflare D1 (SQLite) 支持
- [x] PostgreSQL 支持（双数据库能力）
- [x] 完整的 schema 和迁移
- [x] OpenNext.js Cloudflare 适配器
- [x] 用于部署的 Wrangler 配置
- [ ] Supabase 数据库支持（计划中）

### ✅ 媒体详情与上传增强 (v0.2.1)

- [x] 公开媒体详情接口 `GET /api/media/{id}`（含分类、标签、EXIF、点赞状态）
- [x] 上传图片 SHA-256 哈希重复检测，跳过已存在文件并提示用户
- [x] 数据库 `file_hash` 字段与索引
- [x] 所有时间字段统一为 ISO 8601 格式

### ✅ 首页体验优化 (v0.2.1)

- [x] 日期分组支持时区配置（`NEXT_PUBLIC_TIMEZONE`）
- [x] 空状态文案国际化
- [x] EXIF 日期解析修正（本地时间而非 UTC）

### ✅ 媒体浏览量 (v0.3.0)

- [x] `POST/GET /api/media/{id}/view` 浏览量记录与查询接口
- [x] KV 去重（同 IP + 同照片 5 分钟内只计一次）
- [x] Bot User-Agent 过滤（Googlebot、Bingbot、curl 等）
- [x] 灯箱打开时自动记录并展示浏览量（eye icon）
- [x] 首页支持按浏览量排序（新增"浏览"标签）
- [x] 管理后台媒体列表展示浏览量列与排序
- [x] 数据库 `view_count` 字段与索引

---

## 当前迭代

### 🔄 进行中

- [ ] **内容与展示优化** - 细节打磨（布局、间距、移动端体验）
- [x] **媒体管理优化** - 多图上传、重复检测、EXIF 字段完善
- [ ] **订阅与邮件** - Resend 发送稳定性与错误提示完善
- [x] **API 文档与配置文档** - 维护 App 接入文档

### 🐛 Bug 修复

- [ ] 点赞、浏览、评论、解锁等边缘场景验证
- [ ] 瀑布流极端宽高比兼容

---

## 长期愿景

### 高级体验增强

- [ ] 更丰富的浏览体验（时间线、地图视图、幻灯片）
- [ ] 更好的搜索体验（按 EXIF、位置、标签）
- [ ] 更完善的静态化与 SEO 优化

---

## 技术债务与改进

### 代码质量

- [ ] 添加全面的单元测试（Jest/Vitest）
- [ ] 添加端到端测试（Playwright/Cypress）
- [ ] 增加代码注释和文档
- [ ] 为组件 props 添加 JSDoc 注释
- [ ] 设置 Storybook 用于组件开发
- [ ] 实现正确的错误边界
- [ ] 添加错误追踪（Sentry）

### 架构改进

- [ ] 实现合适的日志系统
- [ ] 为 API 路由添加速率限制
- [ ] 实现缓存策略（Redis/KV）
- [ ] 添加数据库连接池
- [ ] 实现异步任务的队列系统
- [ ] 添加监控和告警（Cloudflare Analytics）

### 安全增强

- [ ] 密码保护系统安全审计
- [ ] 实现 CSRF 保护
- [ ] 添加内容安全策略（CSP）
- [ ] 输入验证和清理审查
- [ ] SQL 注入防护审计
- [ ] XSS 防护审查
- [ ] 添加安全头

### 性能优化

- [ ] 包大小分析和优化
- [ ] 代码拆分优化
- [ ] 非关键组件的懒加载
- [ ] 数据库查询优化
- [ ] 常用查询的索引优化
- [ ] 实现数据库读取副本

---

## 基础设施与运维

### CI/CD 与部署

- [ ] 自动化构建与发布（Cloudflare Workers）
- [ ] 生产环境配置与密钥管理

### 监控与稳定性

- [ ] Cloudflare Analytics
- [ ] 基础告警与错误日志

### 文档

- [x] API 文档
- [x] 配置文档
- [x] 部署指南

---

## 注意事项与考虑因素

- **功能开关**: 使用 `SITE_CONFIG` 切换功能（enableFilters、enableLikes 等）
- **单用户定位**: 以个人作品展示为核心，不引入多用户体系
- **移动优先**: 所有新功能必须在移动设备上可用
- **性能**: 边缘优化是核心差异化优势
- **隐私**: 新闻订阅和评论注意合规性

---

## 代码规范

### 语言与风格

- 统一使用 TypeScript
- 代码风格遵循 ESLint 规则
- 尽量保持函数职责单一、命名清晰

### 文件与目录

- 前台组件放在 `src/components`
- 后台组件放在 `src/components/admin`
- API 路由在 `src/app/api`
- 服务层在 `src/services`

### 业务约定

- 所有列表接口默认支持 `page` / `pageSize`
- 对外接口尽量返回 `ok` 字段
- 日期字段统一 ISO 8601 字符串（`YYYY-MM-DDTHH:mm:ss.sssZ`）

### API 命名约定

- REST 风格，名词使用复数：`/media`、`/albums`、`/comments`
- 子资源用层级表达：`/albums/{id}/media`
- 动作使用动词后缀：`/like`、`/view`、`/unlock`、`/approve`
- 后台接口统一 `/admin` 前缀

### 错误码规范

- 优先使用 HTTP Status Code 反映错误类型
  - `400` 参数缺失或格式错误
  - `401` 未授权
  - `403` 无权限/需要密码
  - `404` 资源不存在
  - `429` 频率限制
  - `500` 服务器错误
- 返回体包含 `ok: false`，并提供 `error` 或 `err` 字段
- 需要前端判断的场景可返回 `code`（如 `PASSWORD_REQUIRED`）

### 统一错误码枚举表

- `PASSWORD_REQUIRED`
  - 场景：访问密码保护相册
  - 建议状态码：`403`
  - 额外字段：`data.hasPassword = true`

- `INVALID_PASSWORD`
  - 场景：相册密码错误
  - 建议状态码：`403`

- `UNAUTHORIZED`
  - 场景：未登录或管理员权限不足
  - 建议状态码：`401`

- `NOT_FOUND`
  - 场景：资源不存在
  - 建议状态码：`404`

- `RATE_LIMITED`
  - 场景：触发频率限制
  - 建议状态码：`429`

- `VALIDATION_ERROR`
  - 场景：参数缺失/格式错误
  - 建议状态码：`400`

- `SERVER_ERROR`
  - 场景：服务端异常
  - 建议状态码：`500`

### 代码提交

- 避免提交未使用的代码与注释
- 避免提交大型无关改动

---

**版本**: 1.3
**维护者**: 项目维护者  
**审查周期**: 按需更新  
